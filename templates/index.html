<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAG Solution</title>
 <link rel="stylesheet" href="/static/styles.css?v=1.0.1" id="main-css"/>
 <script>
   const css = document.getElementById('main-css');
   css.href = `/static/styles.css?v=${Date.now()}`;
 </script>
  <script>
    const $ = (sel) => document.querySelector(sel);

    localStorage.removeItem('mdc_session_id');
    let sessionId = '';

    async function uploadFiles(evt) {
      evt.preventDefault();
      const input = $('#file-input');
      const files = input.files;
      if (!files || files.length === 0) {
        toast('Please choose at least one file');
        return;
      }
      toggleIndexing(true);
      try {
        const fd = new FormData();
        for (const f of files) fd.append('files', f);
        const res = await fetch('/upload', { method: 'POST', body: fd });
        if (!res.ok) throw new Error((await res.json()).detail || 'Upload failed');
        const data = await res.json();
        sessionId = data.session_id;
        localStorage.setItem('mdc_session_id', sessionId);
        $('#chat').style.display = 'block';
        toast('Indexing complete. You can chat now.');
      } catch (e) {
        console.error(e);
        toast('Indexing failed. Try re-uploading.');
      } finally {
        toggleIndexing(false);
      }
    }

    async function sendMessage() {
      const input = $('#message-input');
      const text = input.value.trim();
      if (!sessionId) { toast('Please upload documents first.'); return; }
      if (!text) { return; }
      appendMessage('user', text);
      input.value = '';
      toggleThinking(true);
      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sessionId, message: text })
        });
        if (!res.ok) throw new Error((await res.json()).detail || 'Chat failed');
        const data = await res.json();
        appendMessage('assistant', data.answer);
      } catch (e) {
        console.error(e);
        toast('Thinking failed. Try again.');
      } finally {
        toggleThinking(false);
      }
    }

    function appendMessage(role, text) {
      const container = $('#messages');
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (role === 'user' ? 'user' : 'assistant');
      bubble.textContent = text;
      container.appendChild(bubble);
      container.scrollTop = container.scrollHeight;
    }

    function toggleIndexing(on) {
      $('#upload-btn').disabled = on;
      $('#indexing').style.display = on ? 'inline-block' : 'none';
    }

    function toggleThinking(on) {
      $('#send-btn').disabled = on;
      $('#thinking').style.display = on ? 'inline-block' : 'none';
    }

    function toast(msg) {
      const el = $('#toast');
      el.textContent = msg;
      el.style.opacity = '1';
      setTimeout(() => el.style.opacity = '0', 2500);
    }

    window.addEventListener('DOMContentLoaded', () => {
      $('#choose-files-btn').addEventListener('click', () => $('#file-input').click());
      $('#upload-form').addEventListener('submit', uploadFiles);
      $('#send-btn').addEventListener('click', sendMessage);

      const drop = $('#dropzone');
      drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.classList.add('hover'); });
      drop.addEventListener('dragleave', () => drop.classList.remove('hover'));
      drop.addEventListener('drop', (e) => {
        e.preventDefault();
        drop.classList.remove('hover');
        $('#file-input').files = e.dataTransfer.files;
      });
    });
  </script>
</head>

<body>
  <header>
    <h1>RAG Solution</h1>
  </header>

  <main class="container">

    <div class="card">
      <h2>Document Ingestion (pdf or txt)</h2>
      <form id="upload-form">
        <div id="dropzone">
          <p>Drag and drop files here</p>
          <p>or</p>
          <button type="button" class="btn" id="choose-files-btn">
            Choose files
          </button>
          <input id="file-input" type="file" name="files" multiple hidden />
        </div>
        <p class="hint">After choosing files, click <strong>Upload &amp; Index</strong></p>
        <button id="upload-btn" class="primary" type="submit">Upload & Index</button>
        <span id="indexing" class="hint" style="display:none;">Indexing…</span>
      </form>
    </div>

    <div class="card" id="chat" style="display:none;">
      <h2>Chat</h2>
      <div id="messages" class="messages"></div>
      <div class="composer">
        <textarea id="message-input" rows="2" placeholder="Ask about your documents…"></textarea>
        <button id="send-btn" class="secondary">Send</button>
        <span id="thinking" class="hint" style="display:none;">Thinking…</span>
      </div>
    </div>

    <div class="footer">
      Built with FastAPI · FAISS · SentenceTransformers · GGUF · Hugging Face Spaces Friendly
    </div>

  </main>

  <div id="toast" class="toast"></div>
</body>
</html>
